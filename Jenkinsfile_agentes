pipeline {
    agent none

    environment {
        AWS_REGION         = 'us-east-1'
        S3_BUCKET_NAME     = 'aws-sam-cli-managed-default-samclisourcebucket-bzstlrjji7cw'
        STAGING_STACK_NAME = 'todo-api-staging'
    }

    stages {
        stage('Análisis Estático') {
            agent { label 'static-agent' }
            steps {
                checkout scm
                sh '''
                    echo "--- Instalando herramientas de análisis ---"
                    pip install -q flake8 bandit --break-system-packages
                    echo "--- Ejecutando Flake8 y Bandit ---"
                    /home/jenkins/.local/bin/flake8 ./src --output-file=flake8-report.txt || true
                    /home/jenkins/.local/bin/bandit -r ./src -f html -o bandit-report.html || true
                '''
                echo "--- Publicando informes ---"
                publishHTML(target: [ reportDir: '.', reportFiles: 'flake8-report.txt', reportName: 'Informe Flake8' ])
                publishHTML(target: [ reportDir: '.', reportFiles: 'bandit-report.html', reportName: 'Informe Bandit' ])
            }
        }

        stage('Despliegue en Staging') {
            agent { label 'deploy-test-agent' }
            steps {
                checkout scm
                echo "--- Construyendo y desplegando con SAM ---"
                sh 'sam build'
                sh """
                    sam deploy \\
                        --stack-name ${STAGING_STACK_NAME} \\
                        --s3-bucket ${S3_BUCKET_NAME} \\
                        --capabilities CAPABILITY_IAM \\
                        --region ${AWS_REGION} \\
                        --no-fail-on-empty-changeset \\
                        --parameter-overrides DynamoDBTableName=staging-todos-table
                """
                script {
                    echo "--- Obteniendo y guardando la URL de la API ---"
                    def apiUrl = sh(
                        script: "aws cloudformation describe-stacks --stack-name ${STAGING_STACK_NAME} --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' --output text --region ${AWS_REGION}",
                        returnStdout: true
                    ).trim()
                    writeFile file: 'api_url.txt', text: apiUrl
                    // CORRECCIÓN: Usamos 'includes' en lugar de 'files'
                    stash name: 'apiInfo', includes: 'api_url.txt'
                }
            }
        }

        stage('Pruebas de Integración (Pytest)') {
            agent { label 'deploy-test-agent' }
            steps {
                echo "--- Recuperando la URL de la API ---"
                unstash 'apiInfo'
                script {
                    def apiUrl = readFile('api_url.txt').trim()
                    echo "--- Ejecutando pruebas contra: ${apiUrl} ---"
                    sh 'pip install -q -r test/integration/requirements.txt --break-system-packages'
                    sh """
                        export PATH="/home/jenkins/.local/bin:\$PATH"
                        API_URL=${apiUrl} pytest test/integration/todoApiTest.py
                    """
                }
            }
        }

        stage('Promoción a Master') {
            agent { label 'deploy-test-agent' }
            steps {
                checkout scm
                echo "--- Fusionando 'develop' con 'master' ---"
                // Ahora que el plugin está instalado, este comando funcionará
                sshagent(credentials: ['github-ssh-key']) {
                    sh '''
                        git config --global user.email "jenkins@kevin.com"
                        git config --global user.name "Jenkins CI"
                        git checkout master
                        git merge origin/develop
                        git push origin master
                    '''
                }
            }
        }
    }
}